<!doctype html>
<html lang="es">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>UTN Tracker - Materias</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
		<link href="assets/css/index.css" rel="stylesheet">
		<link rel="shortcut icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQFISZCyThgDrLoWO4a9PB-oxJTqfbiI4KGIA&s" type="image/x-icon">
	</head>
	<body>
		<div class="container-fluid">
			<!-- Top toolbar (not a navbar) -->
			<div class="toolbar d-flex justify-content-between align-items-center">
				<div class="d-flex align-items-center" role="group" aria-label="Herramientas">
					<select id="programSelect" class="form-select me-2" aria-label="Programas">
						<option value="isi-k23">Ingeniería en Sistemas de Información - K23</option>
					</select>
					<button class="btn btn-outline-secondary" id="btn-electivas">electivas</button>
				</div>
				<div class="btn-group">
					<button class="btn btn-light">Vista</button>
					<button class="btn btn-light">Orden</button>
				</div>
				<!-- Help button to explain arrow legend -->
				<div class="ms-2">
					<button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#helpModal" id="btn-help">
						Ayuda
					</button>
				</div>
				<!-- Profile / Login button (opens profile modal) -->
				<div class="ms-2">
					<button type="button" class="btn btn-outline-secondary" id="btn-profile" data-bs-toggle="modal" data-bs-target="#profileModal" aria-label="Perfil">
						Perfil
					</button>
				</div>
				<!-- Settings button (opens settings modal) -->
				<div class="ms-2">
					<button type="button" class="btn btn-outline-secondary" id="btn-settings" data-bs-toggle="modal" data-bs-target="#settingsModal" aria-label="Configuración">
						<i class="bi bi-gear"></i>
					</button>
				</div>
			</div>

			<!-- Columns with subject cards -->
			<section class="columns-grid" aria-label="Materias">
				<!-- Columns produced dynamically by JS -->
			</section>

			<!-- Bottom statistics and progress -->
			<section class="mt-3">
				<div class="stats-row">
					<div class="card stat-card p-2">
						<div class="small text-muted">Horas semanales</div>
							<div id="stat-peso" class="h5">—</div>
					</div>
					<div class="card stat-card p-2">
						<div class="small text-muted">Promedio</div>
						<div id="stat-promedio" class="h5">—</div>
					</div>
					<div class="card stat-card p-2">
						<div class="small text-muted">Materias aprobadas</div>
						<div id="stat-placeholder-1" class="h6">—</div>
					</div>
					<div class="card stat-card p-2">
						<div class="small text-muted">Finales pendientes</div>
						<div id="stat-placeholder-2" class="h6">—</div>
					</div>
					<div class="card stat-card p-2">
						<div class="small text-muted">Materias que pueden cursarse</div>
						<div id="stat-disponibles" class="h6">—</div>
					</div>
				</div>

				<div class="progress-wrap">
					<div class="d-flex justify-content-between">
						<small class="text-muted">Progreso de aprobadas</small>
						<small id="progress-label" class="text-muted">0%</small>
					</div>
					<div class="progress" aria-hidden="false">
						<div id="progress-bar" class="progress-bar bg-success" role="progressbar" aria-labelledby="progress-label" aria-valuemin="0" aria-valuemax="100"></div>
					</div>
				</div>
			</section>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script src="assets/js/index.js"></script>

		<!-- Help modal explaining correlativas legend -->
		<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="helpModalLabel">Leyenda de correlativas</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
		      </div>
		      <div class="modal-body">
		        <p>Las correlativas se muestran con flechas que indican dependencias entre materias:</p>
		        <ul>
		          <li><strong>Flechas negras</strong>: requisito <em>para cursar</em> (asistencia/inscripción).</li>
		          <li><strong>Flechas verdes</strong>: requisito <em>para aprobar</em> (condición para la calificación final).</li>
		        </ul>
		        <p>Para los requisitos <em>para aprobar</em> hay dos estados:</p>
		        <ul>
		          <li>Linea continua: la materia debe estar <strong>aprobada</strong>.</li>
		          <li>Linea punteada: la materia puede estar <strong>regularizada</strong> (no necesariamente aprobada).</li>
		        </ul>
		        <p>Ejemplo:</p>
				<div class="d-flex gap-2 align-items-center">
					<svg width="80" height="20"><defs><marker id="help-arrow-black" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#000"></polygon></marker></defs><path d="M5 10 L70 10" stroke="#000" stroke-width="2" fill="none" marker-end="url(#help-arrow-black)"></path></svg>
					<span>Requisito para cursar - aprobado (negro, continuo)</span>
				</div>
				<div class="d-flex gap-2 align-items-center">
					<svg width="80" height="20"><defs><marker id="help-arrow-black" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#000"></polygon></marker></defs><path d="M5 10 L70 10" stroke="#000" stroke-width="2" fill="none" stroke-dasharray="6,4" marker-end="url(#help-arrow-black)"></path></svg>
					<span>Requisito para cursar - regularizada (negro, punteado)</span>
				</div>
				<div class="d-flex gap-2 align-items-center mt-2">
					<svg width="80" height="20"><defs><marker id="help-arrow-green" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#28a745"></polygon></marker></defs><path d="M5 10 L70 10" stroke="#28a745" stroke-width="2" fill="none" marker-end="url(#help-arrow-green)"></path></svg>
					<span>Requisito para aprobar - aprobado (verde, continuo)</span>
				</div>
				<div class="d-flex gap-2 align-items-center mt-2">
					<svg width="80" height="20"><defs><marker id="help-arrow-green" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#28a745"></polygon></marker></defs><path d="M5 10 L70 10" stroke="#28a745" stroke-width="2" fill="none" stroke-dasharray="6,4" marker-end="url(#help-arrow-green)"></path></svg>
					<span>Requisito para aprobar - regularizada (verde, punteado)</span>
				</div>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
		      </div>
		    </div>
		  </div>
		</div>

		<!-- Profile / Auth modal (HTML only - JS to be implemented later) -->
		<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
			  <div class="modal-header">
				<h5 class="modal-title" id="profileModalLabel">Cuenta / Perfil</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			  </div>
			  <div class="modal-body">
				<!-- Note: JS will show/hide sections depending on auth state -->
				<!-- Sign-in section -->
				<div id="profile-signin" class="auth-section">
				  <h6>Iniciar sesión</h6>
				  <div class="mb-2">
					<!-- Google Sign-In button -->
					<button id="profile-google-btn" class="btn btn-outline-danger w-100 mb-2" type="button" aria-label="Iniciar sesión con Google">
					  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48" style="vertical-align:middle;margin-right:8px;">
						<path fill="#EA4335" d="M24 9.5c3.9 0 7.1 1.4 9.4 3.2l6.9-6.9C35.6 2.9 30.1 0 24 0 14.7 0 6.9 5 2.9 12.3l7.9 6.1C12.9 14 18 9.5 24 9.5z"/>
						<path fill="#34A853" d="M46.5 24.5c0-1.6-.1-3.1-.4-4.6H24v9h12.7c-.6 3-2.3 5.2-4.9 6.9l7.5 5.8C44.7 37.2 46.5 31.2 46.5 24.5z"/>
						<path fill="#4A90E2" d="M10.8 28.4A14.8 14.8 0 0110 24c0-1.6.3-3.1.8-4.5L2.9 13.4A24 24 0 000 24c0 3.8.9 7.4 2.6 10.6l8.2-6.2z"/>
						<path fill="#FBBC05" d="M24 48c6 0 11.1-2 15-5.5l-7.5-5.8c-2 1.4-4.6 2.3-7.5 2.3-6 0-11.1-3.9-13-9.2l-8.2 6.2C6.9 43 14.7 48 24 48z"/>
					  </svg>
					  Continuar con Google
					</button>
				  </div>
				  <div class="mb-2">
					<label class="form-label small">Email</label>
					<input id="profile-email-signin" type="email" class="form-control" placeholder="tu@ejemplo.com" />
				  </div>
				  <div class="mb-2">
					<label class="form-label small">Contraseña</label>
					<input id="profile-password-signin" type="password" class="form-control" placeholder="Contraseña" />
				  </div>
				  <div class="d-flex gap-2">
					<button id="profile-signin-btn" class="btn btn-primary">Iniciar sesión</button>
					<button id="profile-show-register" class="btn btn-link">Registrarse</button>
				  </div>
				</div>
				<!-- Register section -->
				<div id="profile-register" class="auth-section d-none">
				  <h6>Crear cuenta</h6>
				  <div class="mb-2">
					<label class="form-label small">Nombre para mostrar</label>
					<input id="profile-name-register" type="text" class="form-control" placeholder="Tu nombre" />
				  </div>
				  <div class="mb-2">
					<label class="form-label small">Email</label>
					<input id="profile-email-register" type="email" class="form-control" placeholder="tu@ejemplo.com" />
				  </div>
				  <div class="mb-2">
					<label class="form-label small">Contraseña</label>
					<input id="profile-password-register" type="password" class="form-control" placeholder="Contraseña" />
				  </div>
				  <div class="d-flex gap-2">
					<button id="profile-register-btn" class="btn btn-primary">Crear cuenta</button>
					<button id="profile-show-signin" class="btn btn-link">Volver a iniciar sesión</button>
				  </div>
				</div>
				<!-- User info section (visible when logged in) -->
				<div id="profile-user" class="auth-section d-none">
				  <h6>Sesión iniciada</h6>
				  <div class="mb-2"><strong id="profile-user-name">Nombre</strong></div>
				  <div class="mb-2 text-muted" id="profile-user-email">email@ejemplo.com</div>
				  <div class="d-flex gap-2">
					<button id="profile-signout-btn" class="btn btn-outline-danger">Cerrar sesión</button>
					<button id="profile-sync-btn" class="btn btn-outline-secondary">Sincronizar ahora</button>
				  </div>
				  <div class="mt-3"><small class="text-muted">Cuando inicies sesión, podrás sincronizar tu tablero entre dispositivos.</small></div>
				</div>
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
			  </div>
			</div>
		  </div>
		</div>

		<!-- Settings modal -->
		<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
			  <div class="modal-header">
				<h5 class="modal-title" id="settingsModalLabel">Configuración</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			  </div>
			  <div class="modal-body">
				<!-- Mostrar correlativas toggle -->
				<div class="form-check form-switch mb-3">
				  <input class="form-check-input" type="checkbox" id="settings-correlativas" role="switch" checked>
				  <label class="form-check-label" for="settings-correlativas">Mostrar correlativas</label>
				  <div class="form-text">Muestra las flechas de correlativas al pasar el cursor sobre las materias.</div>
				</div>
				<!-- Ver estado de materias toggle -->
				<div class="form-check form-switch mb-3">
				  <input class="form-check-input" type="checkbox" id="settings-show-status" role="switch">
				  <label class="form-check-label" for="settings-show-status">Ver estado de materias</label>
				  <div class="form-text">Muestra el estado debajo de cada materia en el tablero.</div>
				</div>
				<!-- Mostrar públicamente toggle (syncs with Firebase) -->
				<div class="form-check form-switch mb-3">
				  <input class="form-check-input" type="checkbox" id="settings-share-toggle">
				  <label class="form-check-label" for="settings-share-toggle">Compartir públicamente</label>
				  <div class="form-text" id="settings-share-note">Activa para compartir tu tablero públicamente. Requiere iniciar sesión.</div>
				  <div class="mt-2 small">
					<span id="settings-share-link-wrap" style="display:none;">
					  Enlace público: <a href="#" id="settings-share-link" target="_blank" rel="noopener"></a>
					</span>
				  </div>
				</div>
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
			  </div>
			</div>
		  </div>
		</div>

		<!-- Small footer -->
		<footer class="app-footer mt-3">
			<div class="container-fluid d-flex justify-content-between align-items-center">
				<div class="small text-muted">Hecho con amor por <a href="https://scalise.ar" target="_blank" rel="noopener">Federico Scalise Giussani</a></div>
				<div>
					<a class="btn btn-sm btn-outline-secondary github-btn" href="https://github.com/Duplino/UTN-Tracker" target="_blank" rel="noopener" aria-label="Ver repositorio en GitHub">
						<!-- GitHub mark (small) -->
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8a8 8 0 005.47 7.59c.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2 .37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.6 7.6 0 012 0c1.53-1.03 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.28.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
						<span class="visually-hidden">GitHub</span>
					</a>
				</div>
			</div>
		</footer>

			<!-- Electivas modal -->
			<div class="modal fade" id="electivasModal" tabindex="-1" aria-labelledby="electivasModalLabel" aria-hidden="true">
			  <div class="modal-dialog modal-lg modal-dialog-centered">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" id="electivasModalLabel">Materias Electivas</h5>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			      </div>
			      <div class="modal-body">
			        <div id="electivas-container" class="row g-2">
			          <!-- Electivas cards injected here -->
			        </div>
			      </div>
			      <div class="modal-footer">
			        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
			      </div>
			    </div>
			  </div>
			</div>

		<!-- Subject modal for entering parciales and finales -->
		<div class="modal fade" id="subjectModal" tabindex="-1" aria-labelledby="subjectModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="subjectModalLabel">Materia</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
		      </div>
		      <div class="modal-body">
				<form id="subject-form">
					<!-- PRIMER PARCIAL: input-group with three inputs -->
					<div class="mb-2">
						<label class="form-label">Primer Parcial</label>
						<div id="parcial1-group" class="input-group" role="group" aria-label="Primer parcial">
							<input id="parcial1_1" data-attempt="1" type="number" min="0" max="10" step="0.1" class="form-control" placeholder="Ingrese nota" />
							<input id="parcial1_2" data-attempt="2" type="number" min="0" max="10" step="0.1" class="form-control d-none" placeholder="Debe Recuperar" />
							<input id="parcial1_3" data-attempt="3" type="number" min="0" max="10" step="0.1" class="form-control d-none" placeholder="Debe Recuperar" />
						</div>
					</div>

					<!-- SEGUNDO PARCIAL: input-group with three inputs -->
					<div class="mb-3">
						<label class="form-label">Segundo Parcial</label>
						<div id="parcial2-group" class="input-group" role="group" aria-label="Segundo parcial">
							<input id="parcial2_1" data-attempt="1" type="number" min="0" max="10" step="0.1" class="form-control" placeholder="Ingrese nota" />
							<input id="parcial2_2" data-attempt="2" type="number" min="0" max="10" step="0.1" class="form-control d-none" placeholder="Debe Recuperar" />
							<input id="parcial2_3" data-attempt="3" type="number" min="0" max="10" step="0.1" class="form-control d-none" placeholder="Debe Recuperar" />
						</div>
					</div>

					<!-- Finales: four inputs on a single group row -->
					<div class="mb-3">
						<label class="form-label">Finales</label>
						<div id="finals-container" class="input-group" role="group" aria-label="Notas de finales">
							<input id="final1" data-attempt="1" type="number" min="0" max="10" step="0.1" class="form-control" placeholder="Final 1">
							<input id="final2" data-attempt="2" type="number" min="0" max="10" step="0.1" class="form-control d-none" placeholder="Final 2">
							<input id="final3" data-attempt="3" type="number" min="0" max="10" step="0.1" class="form-control d-none" placeholder="Final 3">
							<input id="final4" data-attempt="4" type="number" min="0" max="10" step="0.1" class="form-control d-none" placeholder="Final 4">
						</div>
					</div>
				</form>

				<!-- Dynamic status banner (updated live) -->
				<div id="subject-status" class="mt-3" aria-live="polite" aria-atomic="true"></div>
				<!-- Static override control moved to HTML to avoid dynamic injection/removal by JS -->
				<div id="subject-override-wrap" class="mt-2" style="display:flex;gap:6px;align-items:center;">
					<label for="subject-override" class="form-label small mb-0" style="margin-bottom:0;">Override:</label>
					<select id="subject-override" class="form-select form-select-sm" style="width:auto;">
						<option value="computed">Usar calculado</option>
						<option value="Aprobada">Aprobada</option>
						<option value="Promocionada">Promocionada</option>
						<option value="Regularizada">Regularizada</option>
						<option value="No regularizada">No regularizada</option>
						<option value="Desaprobada">Desaprobada</option>
						<option value="Faltan notas">Faltan notas</option>
					</select>
				</div>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
		        <button type="button" class="btn btn-primary" id="subject-save">Guardar</button>
		      </div>
		    </div>
		  </div>
		</div>

		<script type="module">
			// Import the functions you need from the SDKs you need
			import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
			import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
			import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
			import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, onSnapshot, deleteField } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
			// TODO: Add SDKs for Firebase products that you want to use
			// https://firebase.google.com/docs/web/setup#available-libraries

			// Your web app's Firebase configuration
			// For Firebase JS SDK v7.20.0 and later, measurementId is optional
			const firebaseConfig = {
				apiKey: "AIzaSyB4n2_ZY0tBjwMzoQqvjjUHlqD0Yu6Dr0A",
				authDomain: "utntracker.firebaseapp.com",
				projectId: "utntracker",
				storageBucket: "utntracker.firebasestorage.app",
				messagingSenderId: "791264678302",
				appId: "1:791264678302:web:e637c2e3b499614683868f",
				measurementId: "G-T4WYQC67SW"
			};

			// Initialize Firebase
			const app = initializeApp(firebaseConfig);
			const analytics = getAnalytics(app);

			// Auth: Google sign-in and simple UI wiring for the profile modal
			const auth = getAuth(app);
			const provider = new GoogleAuthProvider();

			// Firestore initialization
			const db = getFirestore(app);
			let userDocUnsubscribe = null;

			// Helper: upload a single subject to the user's Firestore doc under `subjectData.{code}`
			window.firestoreUploadSubject = async function(code, payload){
				try{
					if (!auth || !auth.currentUser) return;
					const ref = doc(db, 'users', auth.currentUser.uid);
					// If overrideStatus is not present in payload, explicitly delete it from Firebase
					// (merge:true won't delete missing fields, so we must use deleteField())
					const payloadToUpload = { ...payload };
					if (!('overrideStatus' in payloadToUpload)) {
						payloadToUpload.overrideStatus = deleteField();
					}
					// set the nested field subjectData.code to payload (merge)
					await setDoc(ref, { subjectData: { [code]: payloadToUpload }, updatedAt: serverTimestamp() }, { merge: true });
				}catch(err){ console.error('firestoreUploadSubject error', err); }
			};

			// Helper: delete a subject field from subjectData
			window.firestoreDeleteSubject = async function(code){
				try{
					if (!auth || !auth.currentUser) return;
					const ref = doc(db, 'users', auth.currentUser.uid);
					await updateDoc(ref, { [`subjectData.${code}`]: deleteField(), updatedAt: serverTimestamp() });
				}catch(err){ console.error('firestoreDeleteSubject error', err); }
			};

			// Helper: upload electives map wholesale
			window.firestoreUploadElectives = async function(mapObj){
				try{
					if (!auth || !auth.currentUser) return;
					const ref = doc(db, 'users', auth.currentUser.uid);
					await setDoc(ref, { electives: mapObj, updatedAt: serverTimestamp() }, { merge: true });
				}catch(err){ console.error('firestoreUploadElectives error', err); }
			};

			// Helper: set public flag on user doc
			window.firestoreSetPublic = async function(flag){
				try{
					if (!auth || !auth.currentUser) return;
					const ref = doc(db, 'users', auth.currentUser.uid);
					await updateDoc(ref, { public: !!flag, updatedAt: serverTimestamp() });
					return true;
				}catch(err){ console.error('firestoreSetPublic error', err); return false; }
			};

			// Helper: delete a single elective entry from the user's electives map
			window.firestoreDeleteElective = async function(code){
				try{
					if (!auth || !auth.currentUser) return;
					const ref = doc(db, 'users', auth.currentUser.uid);
					await updateDoc(ref, { [`electives.${code}`]: deleteField(), updatedAt: serverTimestamp() });
				}catch(err){ console.error('firestoreDeleteElective error', err); }
			};

			// Helper: download user doc and merge into localStorage (overwrite local keys)
			window.firestoreDownloadAndApply = async function(){
				try{
					if (!auth || !auth.currentUser) return null;
					const ref = doc(db, 'users', auth.currentUser.uid);
					const snap = await getDoc(ref);
					if (!snap.exists()) return null;
					const data = snap.data() || {};
					// Apply subjectData: overwrite local keys with remote and remove local keys that no longer exist remotely
					try{
						window.__firestoreApplyingRemote = true;
						const remote = data.subjectData && typeof data.subjectData === 'object' ? data.subjectData : {};
						// set/overwrite remote entries
						Object.keys(remote).forEach(code => {
							try{ localStorage.setItem('subjectData:' + code, JSON.stringify(remote[code])); }catch(e){}
						});
						// remove any local subjectData keys not present in remote
						for (let i = 0; i < localStorage.length; i++){
							const k = localStorage.key(i);
							if (!k) continue;
							if (k.startsWith('subjectData:')){
								const code = k.replace('subjectData:','');
								if (!remote.hasOwnProperty(code)){
									try{ localStorage.removeItem(k); }catch(e){}
								}
							}
						}
					}finally{ window.__firestoreApplyingRemote = false; }
					// Merge electives and mostrarCorrelativas if present
					if (typeof data.electives !== 'undefined'){
						try{ localStorage.setItem('electives', JSON.stringify(data.electives)); }catch(e){}
					}
					if (typeof data.mostrarCorrelativas !== 'undefined'){
						try{ localStorage.setItem('mostrarCorrelativas', data.mostrarCorrelativas ? '1' : '0'); }catch(e){}
					}
					// Note: do NOT dispatch an event here to avoid duplicate reloads; caller may reload or re-render as needed.
					return data;
				}catch(err){ console.error('firestoreDownloadAndApply error', err); return null; }
			};

			// Setup real-time listener on user's doc to apply remote changes automatically
			async function startUserDocListener(uid){
				try{
					const ref = doc(db, 'users', uid);
					if (userDocUnsubscribe) userDocUnsubscribe();
					let first = true;
					userDocUnsubscribe = onSnapshot(ref, (snap) => {
						if (!snap.exists()) return;
						// ignore the initial snapshot delivered immediately after subscribing
						if (first){ first = false; return; }
						const data = snap.data() || {};
						// apply remote changes to localStorage (set remote keys and remove local keys that no longer exist)
						try{
							window.__firestoreApplyingRemote = true;
							const remote = data.subjectData && typeof data.subjectData === 'object' ? data.subjectData : {};
							Object.keys(remote).forEach(code => {
								try{ localStorage.setItem('subjectData:' + code, JSON.stringify(remote[code])); }catch(e){}
							});
							// remove local keys not present in remote
							for (let i = 0; i < localStorage.length; i++){
								const k = localStorage.key(i);
								if (!k) continue;
								if (k.startsWith('subjectData:')){
									const code = k.replace('subjectData:','');
									if (!remote.hasOwnProperty(code)){
										try{ localStorage.removeItem(k); }catch(e){}
									}
								}
							}
							if (typeof data.electives !== 'undefined') try{ localStorage.setItem('electives', JSON.stringify(data.electives)); }catch(e){}
							if (typeof data.mostrarCorrelativas !== 'undefined') try{ localStorage.setItem('mostrarCorrelativas', data.mostrarCorrelativas ? '1' : '0'); }catch(e){}
						}finally{ window.__firestoreApplyingRemote = false; }
						// notify app to refresh UI (only for subsequent updates)
						document.dispatchEvent(new CustomEvent('firestore:remote-update', { detail: { from: 'onSnapshot' } }));
					});
				}catch(err){ console.error('startUserDocListener error', err); }
			}

			function showSigninSection() {
	 			document.getElementById('profile-signin').classList.remove('d-none');
	 			document.getElementById('profile-register').classList.add('d-none');
	 			document.getElementById('profile-user').classList.add('d-none');
	 		}

			// Ensure modal starts on sign-in section by default
			showSigninSection();

	 		document.getElementById('profile-show-register').addEventListener('click', (e) => {
	 			e.preventDefault();
	 			document.getElementById('profile-signin').classList.add('d-none');
	 			document.getElementById('profile-register').classList.remove('d-none');
	 		});

	 		document.getElementById('profile-show-signin').addEventListener('click', (e) => {
	 			e.preventDefault();
	 			showSigninSection();
	 		});

	 		// Google sign-in button
	 		document.getElementById('profile-google-btn').addEventListener('click', async () => {
	 			try {
	 				await signInWithPopup(auth, provider);
	 				// onAuthStateChanged will update UI
	 			} catch (err) {
	 				console.error('Google sign-in error', err);
	 				alert('Error al iniciar con Google: ' + (err.message || err));
	 			}
	 		});

	 		// Sign out button
	 		document.getElementById('profile-signout-btn').addEventListener('click', async () => {
	 			try {
	 				await signOut(auth);
	 				showSigninSection();
	 			} catch (err) {
	 				console.error('Sign-out error', err);
	 				alert('Error al cerrar sesión: ' + (err.message || err));
	 			}
	 		});

			onAuthStateChanged(auth, async (user) => {
				if (user) {
					// Show user info
					document.getElementById('profile-user-name').textContent = user.displayName || 'Usuario';
					document.getElementById('profile-user-email').textContent = user.email || '';
					document.getElementById('profile-user').classList.remove('d-none');
					document.getElementById('profile-signin').classList.add('d-none');
					document.getElementById('profile-register').classList.add('d-none');
					// Enable settings share toggle now that user is logged in
					const settingsShareToggle = document.getElementById('settings-share-toggle');
					if (settingsShareToggle) {
						settingsShareToggle.disabled = false;
					}
					// Download remote state and trigger a single in-place refresh (avoid reload loop)
					try{ await (window.firestoreDownloadAndApply ? window.firestoreDownloadAndApply() : Promise.resolve()); }catch(e){ console.error(e); }
					// Dispatch a single remote-update event so the app re-renders from the freshly-downloaded localStorage
					try{ document.dispatchEvent(new CustomEvent('firestore:remote-update', { detail: { from: 'initialDownload' } })); }catch(e){ console.error(e); }
					// Start realtime listener after initial download (listener will ignore its initial snapshot)
					try{ startUserDocListener(user.uid); }catch(e){ console.error(e); }
					// Initialize share toggle state from Firestore
					try{
						const ref = doc(db, 'users', user.uid);
						const snap = await getDoc(ref);
						if (snap.exists()) {
							const data = snap.data();
							const isPublic = data.public === true;
							if (settingsShareToggle) settingsShareToggle.checked = isPublic;
							// Update UI for share link
							const linkWrap = document.getElementById('settings-share-link-wrap');
							const linkEl = document.getElementById('settings-share-link');
							const noteEl = document.getElementById('settings-share-note');
							if (isPublic) {
								const shareUrl = `${window.location.origin}${window.location.pathname.replace(/index\.html$/, '')}share.html?uid=${user.uid}`;
								if (linkEl) { linkEl.href = shareUrl; linkEl.textContent = shareUrl; }
								if (linkWrap) linkWrap.style.display = '';
								if (noteEl) noteEl.textContent = 'Tu tablero es público.';
							} else {
								if (linkWrap) linkWrap.style.display = 'none';
								if (noteEl) noteEl.textContent = 'Activa para compartir tu tablero públicamente.';
							}
						}
					}catch(e){ console.error('Error loading share state', e); }
				} else {
					// stop listener when signed out
					try{ if (userDocUnsubscribe) userDocUnsubscribe(); }catch(e){}
					showSigninSection();
					// Disable and reset settings share toggle when logged out
					const settingsShareToggle = document.getElementById('settings-share-toggle');
					if (settingsShareToggle) {
						settingsShareToggle.checked = false;
						settingsShareToggle.disabled = true;
					}
					const linkWrap = document.getElementById('settings-share-link-wrap');
					const noteEl = document.getElementById('settings-share-note');
					if (linkWrap) linkWrap.style.display = 'none';
					if (noteEl) noteEl.textContent = 'Activa para compartir tu tablero públicamente. Requiere iniciar sesión.';
				}
			});

			// Settings share toggle change handler
			const settingsShareToggle = document.getElementById('settings-share-toggle');
			if (settingsShareToggle) {
				// Initially disabled until user is logged in
				settingsShareToggle.disabled = true;
				settingsShareToggle.addEventListener('change', async () => {
					const isChecked = settingsShareToggle.checked;
					const user = auth.currentUser;
					if (!user) {
						settingsShareToggle.checked = false;
						alert('Debes iniciar sesión para compartir tu tablero.');
						return;
					}
					try {
						const success = await window.firestoreSetPublic(isChecked);
						if (success) {
							const linkWrap = document.getElementById('settings-share-link-wrap');
							const linkEl = document.getElementById('settings-share-link');
							const noteEl = document.getElementById('settings-share-note');
							if (isChecked) {
								const shareUrl = `${window.location.origin}${window.location.pathname.replace(/index\.html$/, '')}share.html?uid=${user.uid}`;
								if (linkEl) { linkEl.href = shareUrl; linkEl.textContent = shareUrl; }
								if (linkWrap) linkWrap.style.display = '';
								if (noteEl) noteEl.textContent = 'Tu tablero es público.';
							} else {
								if (linkWrap) linkWrap.style.display = 'none';
								if (noteEl) noteEl.textContent = 'Activa para compartir tu tablero públicamente.';
							}
						} else {
							settingsShareToggle.checked = !isChecked;
							alert('Error al actualizar la configuración de compartir.');
						}
					} catch (err) {
						console.error('Error updating share setting', err);
						settingsShareToggle.checked = !isChecked;
						alert('Error al actualizar la configuración de compartir.');
					}
				});
			}
		</script>
	</body>
</html>
