<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UTN-Tracker — Compartido</title>
  <link href="assets/css/index.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container py-4">
    <h3>Tablero público</h3>
    <div id="share-warning" class="alert alert-warning d-none"></div>
    <div id="share-content">
      <div id="share-header" class="mb-3"></div>
      <div id="share-grid" class="columns-grid"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB4n2_ZY0tBjwMzoQqvjjUHlqD0Yu6Dr0A",
      authDomain: "utntracker.firebaseapp.com",
      projectId: "utntracker",
      storageBucket: "utntracker.firebasestorage.app",
      messagingSenderId: "791264678302",
      appId: "1:791264678302:web:e637c2e3b499614683868f",
      measurementId: "G-T4WYQC67SW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }

    async function main(){
      const uid = getParam('uid');
      if (!uid){ document.getElementById('share-warning').classList.remove('d-none'); document.getElementById('share-warning').textContent = 'Falta parámetro uid en la URL.'; return; }
      const ref = doc(db, 'users', uid);
      try{
        const snap = await getDoc(ref);
        if (!snap.exists()){ document.getElementById('share-warning').classList.remove('d-none'); document.getElementById('share-warning').textContent = 'Usuario no encontrado.'; return; }
        const data = snap.data() || {};
        if (!data.public){ document.getElementById('share-warning').classList.remove('d-none'); document.getElementById('share-warning').textContent = 'Este usuario no ha hecho público su tablero.'; return; }
        // render a simple read-only view from local mirror in Firestore: subjectData and electives
        const header = document.getElementById('share-header'); header.innerHTML = `<strong>${data.displayName || 'Usuario'}</strong> — Tablero público`;
        const grid = document.getElementById('share-grid');
        grid.innerHTML = '';
        // Build simple columns grid from subjects.json if present in public doc, else render subjectData flat
        const subjectData = data.subjectData || {};
        // render as simple cards
        const frag = document.createDocumentFragment();
        Object.keys(subjectData).forEach(code => {
          const subj = subjectData[code];
          const card = document.createElement('div');
          card.className = 'card card-subject mb-2';
          card.style.cursor = 'default';
          card.innerHTML = `<div class="card-body p-2"><h6 class="card-title mb-0">${code}</h6><small class="text-muted d-block">${(subj && subj.status) ? subj.status : 'Sin datos'}</small></div>`;
          frag.appendChild(card);
        });
        grid.appendChild(frag);
      }catch(err){ console.error(err); document.getElementById('share-warning').classList.remove('d-none'); document.getElementById('share-warning').textContent = 'Error al leer datos públicos.'; }
    }

    main();
  </script>
</body>
</html>
